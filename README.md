# Home Assistant APC ECU-3 Data Reader

This custom component for Home Assistant fetches data from an APC ECU-3 device and integrates it into your Home Assistant instance. It's currently a work in progress, but functional. You can find more information in this blog post: https://www.123cloud.st/p/the-unexpectedly-direct-path-to-building

## Requirements

- An APC ECU-3 device connected to your network.
- The IP address of your APC ECU-3 device.
- Home Assistant installation.

## Setup

1. **Script Preparation:**
   - Copy the \`solarhtml2json.py\` and \`generate_config.py\` files to your Home Assistant configuration directory. This can be efficiently done using the File Editor add-on. The configuration directory's default path is \`/config\`.

2. **Generate Configuration Using Local Python:**
   - Running \`populate-configuration.py\` requires Python and certain dependencies. Install Python locally on your PC. Then, install needed libraries by running \`pip install requests beautifulsoup4\`.
   - Run \`populate-configuration.py\` locally after replacing \`IP-OF-ECU-3\` in the script with the actual IP of your APC ECU-3 device to generate a \`config_part.yaml\` file.

3. **Integration into Home Assistant:**
   - Add the contents of the generated \`config_part.yaml\` file to your \`configuration.yaml\` file in Home Assistant.
   - To enable the automation of \`solarhtml2json.py\`, refer to the Home Assistant configuration to setup a shell command:
     \```
     shell_command:
       convert_solar_data: python /config/solarhtml2json.py
     \```
   - Use the Home Assistant automation editor to trigger \`convert_solar_data\` shell command at your desired frequency.

4. **Handling Python Dependencies:**
   - For scripts requiring external libraries like \`requests\`, use the Advanced Terminal & SSH add-on. This add-on provides a fully functional Python environment.

5. **Deployment Notes:**
   - Home Assistant Operating System (HAOS) versions come with pre-installed Python libraries compatible with the provided scripts.
   - Store your scripts in the \`/config\` directory to ensure they have the correct execution context within HAOS.
## Usage

Once everything is set up, the solar panel data from your APC ECU-3 device will be available as sensor entities in Home Assistant. You can use these in your automations, display them on your dashboard, or use them in any other way you find useful.

The sensor names are based on the inverter IDs and are automatically generated by the `generate_config.py` script.

Each sensor's state is the current power output of the respective solar panel in Watts.

## Support and Contribution

This project is still under development, and your contributions are very welcome. If you encounter any issues or have suggestions, please open an issue on GitHub. If you can improve the code or add a feature, feel free to fork the repository and create a pull request.

## TODO and Potential Improvements

1. **Error Handling:** Improve error handling in the scripts. Currently, the scripts assume that the web request will always succeed and that the page structure will always be as expected. More robust error handling would make the scripts more reliable and easier to debug.

2. **Script Efficiency:** Optimize the scripts for better performance, especially if the number of inverters or the frequency of updates increases.

3. **Automated Setup:** Create an installation script that automates the setup process, such as placing the scripts in the correct location, generating the configuration, and setting up the automation in Home Assistant.

4. **User Interface:** Develop a custom integration with a user interface for Home Assistant. This would allow users to set up and configure the integration without editing configuration files or running scripts manually.

5. **Data Validation:** Add checks to validate the data before it is used. This could include checking for unreasonable values (e.g., negative power output) or missing values.

6. **Expand Sensor Data:** Currently, the scripts only extract the power output of each inverter. There may be other useful data available from the APC ECU-3 device that could also be made available in Home Assistant.

7. **Logging:** Implement a logging system to keep track of when data is fetched, when errors occur, and other significant events.

8. **Unit Tests:** Write unit tests for the scripts to ensure they work as expected and make future development easier and safer.

9. **Documentation:** Improve documentation, including more detailed setup instructions, explanations of how the scripts work, and examples of how to use the sensor data in Home Assistant.
